<div class="statistics">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a routerLink="/" class="back-link">â† Dashboard</a>
        <h1 class="logo">
          <span class="logo-icon">ğŸ“Š</span>
          Spieler Statistiken
        </h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-refresh" (click)="refresh()" [disabled]="loading()">
          <span class="btn-icon">ğŸ”„</span>
          Aktualisieren
        </button>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Lade alle Statistiken...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-container">
      <div class="error-icon">âš ï¸</div>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="refresh()">Erneut versuchen</button>
    </div>
  }

  @if (!loading() && !error()) {
    <!-- Global Stats Overview -->
    <section class="global-stats">
      <div class="stat-card">
        <div class="stat-icon">ğŸ®</div>
        <div class="stat-content">
          <span class="stat-value">{{ totalRounds() }}</span>
          <span class="stat-label">Gesamt Runden</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
          <span class="stat-value">{{ totalPlayers() }}</span>
          <span class="stat-label">Spieler</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ’€</div>
        <div class="stat-content">
          <span class="stat-value">{{ totalKills() }}</span>
          <span class="stat-label">Gesamt Kills</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">â±ï¸</div>
        <div class="stat-content">
          <span class="stat-value">{{ formatDuration(avgRoundDuration()) }}</span>
          <span class="stat-label">âŒ€ Rundendauer</span>
        </div>
      </div>
    </section>

    <!-- Charts Section -->
    <section class="charts-section">
      <div class="charts-grid">
        <!-- Win Rate Chart -->
        <div class="chart-card">
          <h3>ğŸ† Siege nach Team</h3>
          <div class="chart-container">
            <canvas #winRateChart></canvas>
          </div>
        </div>

        <!-- Top Killers Chart -->
        <div class="chart-card">
          <h3>ğŸ’€ Top Killer</h3>
          <div class="chart-container">
            <canvas #killsChart></canvas>
          </div>
        </div>

        <!-- Weapon Stats Chart -->
        <div class="chart-card">
          <h3>ğŸ”« Beliebteste Waffen</h3>
          <div class="chart-container">
            <canvas #weaponsChart></canvas>
          </div>
        </div>

        <!-- Activity Chart -->
        <div class="chart-card">
          <h3>ğŸ“… AktivitÃ¤t nach Wochentag</h3>
          <div class="chart-container">
            <canvas #activityChart></canvas>
          </div>
        </div>

        <!-- Role Distribution Chart -->
        <div class="chart-card large">
          <h3>ğŸ­ Rollenverteilung</h3>
          <div class="chart-container">
            <canvas #rolesChart></canvas>
          </div>
        </div>

        <!-- Map Stats Chart -->
        <div class="chart-card large">
          <h3>ğŸ—ºï¸ Siege nach Map</h3>
          <div class="chart-container">
            <canvas #mapsChart></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Leaderboards Section -->
    <section class="leaderboards-section">
      <h2 class="section-title">ğŸ… Bestenlisten</h2>

      <div class="leaderboards-grid">
        <!-- Top Killers -->
        <div class="leaderboard-card">
          <h3>ğŸ’€ Beste Kills/Runde</h3>
          <div class="leaderboard-list">
            @for (player of topKillers(); track player.steamId; let i = $index) {
              <div class="leaderboard-item">
                <span
                  class="rank"
                  [class.gold]="i === 0"
                  [class.silver]="i === 1"
                  [class.bronze]="i === 2"
                >
                  {{ i + 1 }}
                </span>
                <span class="player-name">{{ player.displayName }}</span>
                <span class="player-stat">{{ player.killsPerRound }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Best K/D -->
        <div class="leaderboard-card">
          <h3>âš”ï¸ Beste K/D</h3>
          <div class="leaderboard-list">
            @for (player of bestKD(); track player.steamId; let i = $index) {
              <div class="leaderboard-item">
                <span
                  class="rank"
                  [class.gold]="i === 0"
                  [class.silver]="i === 1"
                  [class.bronze]="i === 2"
                >
                  {{ i + 1 }}
                </span>
                <span class="player-name">{{ player.displayName }}</span>
                <span class="player-stat">{{ player.kd }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Best Headshot Rate -->
        <div class="leaderboard-card">
          <h3>ğŸ¯ Beste Headshot Rate</h3>
          <div class="leaderboard-list">
            @for (player of bestHeadshotRate(); track player.steamId; let i = $index) {
              <div class="leaderboard-item">
                <span
                  class="rank"
                  [class.gold]="i === 0"
                  [class.silver]="i === 1"
                  [class.bronze]="i === 2"
                >
                  {{ i + 1 }}
                </span>
                <span class="player-name">{{ player.displayName }}</span>
                <span class="player-stat">{{ player.headshotRate }}%</span>
              </div>
            }
          </div>
        </div>

        <!-- Most Teamkills -->
        @if (mostTeamkills().length > 0) {
          <div class="leaderboard-card shame">
            <h3>ğŸ”ª Teamkiller des Jahres</h3>
            <div class="leaderboard-list">
              @for (player of mostTeamkills(); track player.steamId; let i = $index) {
                <div class="leaderboard-item">
                  <span class="rank shame">{{ i + 1 }}</span>
                  <span class="player-name">{{ player.displayName }}</span>
                  <span class="player-stat negative">{{ player.teamkills }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Best Avg Karma per Round -->
        <div class="leaderboard-card karma-good">
          <h3>âœ¨ Bestes Karma/Runde</h3>
          <div class="leaderboard-list">
            @for (player of avgKarmaPerRound(); track player.steamId; let i = $index) {
              <div class="leaderboard-item">
                <span
                  class="rank"
                  [class.gold]="i === 0"
                  [class.silver]="i === 1"
                  [class.bronze]="i === 2"
                >
                  {{ i + 1 }}
                </span>
                <span class="player-name">{{ player.displayName }}</span>
                <span
                  class="player-stat"
                  [class.positive]="player.avgKarma > 0"
                  [class.negative]="player.avgKarma < 0"
                >
                  {{ player.avgKarma > 0 ? '+' : '' }}{{ player.avgKarma }}
                </span>
              </div>
            }
          </div>
        </div>

        <!-- Worst Avg Karma per Round -->
        <div class="leaderboard-card shame">
          <h3>ğŸ’€ Schlechtestes Karma/Runde</h3>
          <div class="leaderboard-list">
            @for (player of worstAvgKarmaPerRound(); track player.steamId; let i = $index) {
              <div class="leaderboard-item">
                <span class="rank shame">{{ i + 1 }}</span>
                <span class="player-name">{{ player.displayName }}</span>
                <span
                  class="player-stat"
                  [class.positive]="player.avgKarma > 0"
                  [class.negative]="player.avgKarma <= 0"
                >
                  {{ player.avgKarma > 0 ? '+' : '' }}{{ player.avgKarma }}
                </span>
              </div>
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Player Pairs Section -->
    <section class="pairs-section">
      <h2 class="section-title">ğŸ‘« Spieler-Paare</h2>

      <div class="pairs-grid">
        <!-- Best Teammates -->
        <div class="pair-card good">
          <h3>ğŸ¤ Dream Team</h3>
          <p class="pair-description">Beste Winrate als Teammates</p>
          <div class="pair-list">
            @for (
              pair of getItems(bestTeammates(), 'bestTeammates');
              track pair.player1 + pair.player2;
              let i = $index
            ) {
              <div class="pair-item">
                <span
                  class="pair-rank"
                  [class.gold]="i === 0"
                  [class.silver]="i === 1"
                  [class.bronze]="i === 2"
                >
                  {{ i + 1 }}
                </span>
                <div class="pair-players">
                  <span class="pair-name">{{ pair.player1Name }}</span>
                  <span class="pair-separator">+</span>
                  <span class="pair-name">{{ pair.player2Name }}</span>
                </div>
                <div class="pair-stats">
                  <span class="pair-winrate positive">{{ pair.winRate }}%</span>
                  <span class="pair-rounds">{{ pair.roundsTogether }} Runden</span>
                </div>
              </div>
            }
            @if (bestTeammates().length === 0) {
              <div class="pair-empty">Nicht genug Daten</div>
            }
          </div>
          @if (bestTeammates().length > 5) {
            <button class="expand-btn" (click)="toggleExpand('bestTeammates')">
              {{
                isExpanded('bestTeammates')
                  ? 'â–² Weniger anzeigen'
                  : 'â–¼ Alle ' + bestTeammates().length + ' anzeigen'
              }}
            </button>
          }
        </div>

        <!-- Worst Teammates -->
        <div class="pair-card bad">
          <h3>ğŸ’” PechvÃ¶gel</h3>
          <p class="pair-description">Niedrigste Winrate als Teammates</p>
          <div class="pair-list">
            @for (
              pair of getItems(worstTeammates(), 'worstTeammates');
              track pair.player1 + pair.player2;
              let i = $index
            ) {
              <div class="pair-item">
                <span class="pair-rank shame">{{ i + 1 }}</span>
                <div class="pair-players">
                  <span class="pair-name">{{ pair.player1Name }}</span>
                  <span class="pair-separator">+</span>
                  <span class="pair-name">{{ pair.player2Name }}</span>
                </div>
                <div class="pair-stats">
                  <span class="pair-winrate negative">{{ pair.winRate }}%</span>
                  <span class="pair-rounds">{{ pair.roundsTogether }} Runden</span>
                </div>
              </div>
            }
            @if (worstTeammates().length === 0) {
              <div class="pair-empty">Nicht genug Daten</div>
            }
          </div>
          @if (worstTeammates().length > 5) {
            <button class="expand-btn" (click)="toggleExpand('worstTeammates')">
              {{
                isExpanded('worstTeammates')
                  ? 'â–² Weniger anzeigen'
                  : 'â–¼ Alle ' + worstTeammates().length + ' anzeigen'
              }}
            </button>
          }
        </div>

        <!-- Nemesis Pairs -->
        <div class="pair-card nemesis">
          <h3>ğŸ˜ˆ Nemesis</h3>
          <p class="pair-description">Wer tÃ¶tet wen am meisten?</p>
          <div class="pair-list">
            @for (
              pair of getItems(nemesisPairs(), 'nemesisPairs');
              track pair.killer + pair.victim;
              let i = $index
            ) {
              <div class="pair-item nemesis-item">
                <span class="pair-rank">{{ i + 1 }}</span>
                <div class="pair-players nemesis-players">
                  <span class="pair-name killer">{{ pair.killerName }}</span>
                  <span class="kill-arrow">â†’</span>
                  <span class="pair-name victim">{{ pair.victimName }}</span>
                </div>
                <div class="pair-stats">
                  <span class="kill-count">{{ pair.kills }} Kills</span>
                  @if (pair.headshots > 0) {
                    <span class="headshot-count">ğŸ¯ {{ pair.headshots }}</span>
                  }
                </div>
              </div>
            }
            @if (nemesisPairs().length === 0) {
              <div class="pair-empty">Nicht genug Daten</div>
            }
          </div>
          @if (nemesisPairs().length > 5) {
            <button class="expand-btn" (click)="toggleExpand('nemesisPairs')">
              {{
                isExpanded('nemesisPairs')
                  ? 'â–² Weniger anzeigen'
                  : 'â–¼ Alle ' + nemesisPairs().length + ' anzeigen'
              }}
            </button>
          }
        </div>

        <!-- Rivalries -->
        <div class="pair-card rivalry">
          <h3>âš”ï¸ RivalitÃ¤ten</h3>
          <p class="pair-description">Gegenseitige Kills</p>
          <div class="pair-list">
            @for (
              pair of getItems(rivalries(), 'rivalries');
              track pair.player1 + pair.player2;
              let i = $index
            ) {
              <div class="pair-item rivalry-item">
                <span class="pair-rank">{{ i + 1 }}</span>
                <div class="pair-players rivalry-players">
                  <div class="rivalry-player">
                    <span class="pair-name">{{ pair.player1Name }}</span>
                    <span class="rivalry-kills">{{ pair.player1Kills }}</span>
                  </div>
                  <span class="rivalry-vs">vs</span>
                  <div class="rivalry-player">
                    <span class="rivalry-kills">{{ pair.player2Kills }}</span>
                    <span class="pair-name">{{ pair.player2Name }}</span>
                  </div>
                </div>
                <div class="pair-stats">
                  <span class="total-kills">{{ pair.totalKills }} Kills</span>
                </div>
              </div>
            }
            @if (rivalries().length === 0) {
              <div class="pair-empty">Nicht genug Daten</div>
            }
          </div>
          @if (rivalries().length > 5) {
            <button class="expand-btn" (click)="toggleExpand('rivalries')">
              {{
                isExpanded('rivalries')
                  ? 'â–² Weniger anzeigen'
                  : 'â–¼ Alle ' + rivalries().length + ' anzeigen'
              }}
            </button>
          }
        </div>

        <!-- Frequent Duos -->
        <div class="pair-card frequent">
          <h3>ğŸ‘¯ HÃ¤ufige Mitspieler</h3>
          <p class="pair-description">Am meisten zusammen gespielt</p>
          <div class="pair-list">
            @for (
              pair of getItems(frequentDuos(), 'frequentDuos');
              track pair.player1 + pair.player2;
              let i = $index
            ) {
              <div class="pair-item">
                <span
                  class="pair-rank"
                  [class.gold]="i === 0"
                  [class.silver]="i === 1"
                  [class.bronze]="i === 2"
                >
                  {{ i + 1 }}
                </span>
                <div class="pair-players">
                  <span class="pair-name">{{ pair.player1Name }}</span>
                  <span class="pair-separator">&</span>
                  <span class="pair-name">{{ pair.player2Name }}</span>
                </div>
                <div class="pair-stats">
                  <span class="pair-rounds-large">{{ pair.roundsTogether }} Runden</span>
                </div>
              </div>
            }
            @if (frequentDuos().length === 0) {
              <div class="pair-empty">Nicht genug Daten</div>
            }
          </div>
          @if (frequentDuos().length > 5) {
            <button class="expand-btn" (click)="toggleExpand('frequentDuos')">
              {{
                isExpanded('frequentDuos')
                  ? 'â–² Weniger anzeigen'
                  : 'â–¼ Alle ' + frequentDuos().length + ' anzeigen'
              }}
            </button>
          }
        </div>
      </div>
    </section>

    <!-- Player Cards Section -->
    <section class="players-section">
      <h2 class="section-title">ğŸ‘¥ Alle Spieler</h2>

      <div class="players-grid">
        @for (player of playerStats(); track player.steamId) {
          <div class="player-card">
            <div class="player-header">
              <h3 class="player-name">{{ player.displayName }}</h3>
              <span class="player-rounds">{{ player.roundsPlayed }} Runden</span>
            </div>

            <div class="player-stats-grid">
              <div class="player-stat-item">
                <span class="stat-label">Kills</span>
                <span class="stat-value">{{ player.kills }}</span>
              </div>
              <div class="player-stat-item">
                <span class="stat-label">Deaths</span>
                <span class="stat-value">{{ player.deaths }}</span>
              </div>
              <div class="player-stat-item">
                <span class="stat-label">K/D</span>
                <span
                  class="stat-value"
                  [class.positive]="player.kd >= 1"
                  [class.negative]="player.kd < 1"
                >
                  {{ player.kd }}
                </span>
              </div>
              <div class="player-stat-item">
                <span class="stat-label">Headshot %</span>
                <span class="stat-value">{{ player.headshotRate }}%</span>
              </div>
              <div class="player-stat-item">
                <span class="stat-label">Siege</span>
                <span class="stat-value">{{ player.totalWins }}</span>
              </div>
              <div class="player-stat-item">
                <span class="stat-label">Winrate</span>
                <span class="stat-value">{{ player.winRate }}%</span>
              </div>
              <div class="player-stat-item">
                <span class="stat-label">Kills/Runde</span>
                <span class="stat-value">{{ player.killsPerRound }}</span>
              </div>
              <div class="player-stat-item">
                <span class="stat-label">Teamkills</span>
                <span class="stat-value" [class.negative]="player.teamkills > 0">
                  {{ player.teamkills }}
                </span>
              </div>
            </div>

            <div class="player-extras">
              @if (player.favoriteWeapon) {
                <div class="extra-item">
                  <span class="extra-label">ğŸ”« Lieblingswaffe</span>
                  <span class="extra-value">{{ player.favoriteWeapon }}</span>
                </div>
              }
              <div class="extra-item">
                <span class="extra-label">ğŸ›’ Items gekauft</span>
                <span class="extra-value">{{ player.itemsBought }}</span>
              </div>
              <div class="extra-item">
                <span class="extra-label">âœ¨ Karma</span>
                <span
                  class="extra-value"
                  [class.positive]="player.karmaTotal > 0"
                  [class.negative]="player.karmaTotal < 0"
                >
                  {{ player.karmaTotal > 0 ? '+' : '' }}{{ player.karmaTotal }}
                </span>
              </div>
              <div class="extra-item">
                <span class="extra-label">â­ Punkte</span>
                <span
                  class="extra-value"
                  [class.positive]="player.pointsTotal > 0"
                  [class.negative]="player.pointsTotal < 0"
                >
                  {{ player.pointsTotal > 0 ? '+' : '' }}{{ player.pointsTotal }}
                </span>
              </div>
            </div>

            <!-- Mini Role Distribution -->
            <div class="player-roles">
              <span class="roles-label">Gespielte Rollen:</span>
              <div class="roles-tags">
                @for (entry of player.rolesPlayed | keyvalue; track entry.key) {
                  <span class="role-tag" [ngClass]="getRoleClass(entry.key)">
                    {{ entry.key }} ({{ entry.value }})
                  </span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </section>

    <!-- Weapon Stats Table -->
    <section class="weapons-section">
      <h2 class="section-title">ğŸ”« Waffen Statistiken</h2>

      <div class="weapons-table">
        <div class="table-header">
          <span>Waffe</span>
          <span>Kills</span>
          <span>Headshots</span>
          <span>HS Rate</span>
        </div>
        @for (weapon of weaponStats(); track weapon.weapon) {
          <div class="table-row">
            <span class="weapon-name">{{ weapon.weapon }}</span>
            <span class="weapon-kills">{{ weapon.kills }}</span>
            <span class="weapon-headshots">{{ weapon.headshots }}</span>
            <span class="weapon-hsrate">{{ weapon.headshotRate }}%</span>
          </div>
        }
      </div>
    </section>

    <!-- Map Stats Table -->
    <section class="maps-section">
      <h2 class="section-title">ğŸ—ºï¸ Map Statistiken</h2>

      <div class="maps-table">
        <div class="table-header">
          <span>Map</span>
          <span>Runden</span>
          <span>Innocent Siege</span>
          <span>Traitor Siege</span>
          <span>Balance</span>
        </div>
        @for (map of mapStats(); track map.mapName) {
          <div class="table-row">
            <span class="map-name">{{ map.mapName }}</span>
            <span class="map-rounds">{{ map.roundsPlayed }}</span>
            <span class="map-innocent">{{ map.innocentWins }}</span>
            <span class="map-traitor">{{ map.traitorWins }}</span>
            <span
              class="map-balance"
              [class.innocent-favored]="map.innocentWins > map.traitorWins"
              [class.traitor-favored]="map.traitorWins > map.innocentWins"
            >
              @if (map.roundsPlayed > 0) {
                {{ ((map.innocentWins / map.roundsPlayed) * 100).toFixed(0) }}% /
                {{ ((map.traitorWins / map.roundsPlayed) * 100).toFixed(0) }}%
              }
            </span>
          </div>
        }
      </div>
    </section>
  }
</div>
