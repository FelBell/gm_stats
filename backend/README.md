# TTT Stats Backend

A Flask REST API to collect and serve statistics for GMod TTT.

## Configuration

Environment variables:

- `DATABASE_URL`: PostgreSQL connection string (e.g., `postgresql://user:pass@db:5432/dbname`).
- `API_KEY`: Secret key required for the `/api/collect` endpoint.

## Database Schema

The database uses SQLAlchemy with the following relational models:

### `rounds`
Stores summary data for each TTT round.
- `id` (String(36), PK): UUIDv4 generated by the addon.
- `map_name` (String(128)): Name of the map.
- `winner` (String(64)): Winning team (e.g., 'traitors', 'innocents').
- `duration` (Integer): Round duration in seconds.
- `timestamp` (DateTime): UTC timestamp of record creation.

### `round_players`
Tracks player participation and roles for each round.
- `id` (Integer, PK): Internal ID.
- `round_id` (String(36), FK): Reference to `rounds.id`.
- `steam_id` (String(64)): Player's SteamID.
- `role_start` (String(32)): Role assigned at round start.
- `role_end` (String(32)): Role held at round end.

### `kills`
Records every kill event within a round.
- `id` (Integer, PK): Internal ID.
- `round_id` (String(36), FK): Reference to `rounds.id`.
- `attacker_steamid` (String(64), Nullable): SteamID of the killer (null if world/environment).
- `attacker_role` (String(32), Nullable): Role of the killer.
- `victim_steamid` (String(64)): SteamID of the victim.
- `victim_role` (String(32)): Role of the victim.
- `weapon` (String(64)): Weapon class used.
- `headshot` (Boolean): True if it was a headshot.

### `round_buys`
Records equipment purchases during a round.
- `id` (Integer, PK): Internal ID.
- `round_id` (String(36), FK): Reference to `rounds.id`.
- `steam_id` (String(64)): Player's SteamID.
- `role` (String(32)): Role of the player at the time of purchase.
- `item` (String(64)): Item identifier or weapon class.

### `players`
Stores unique player information.
- `steam_id` (String(64), PK): The player's unique SteamID.
- `display_name` (String(128)): The player's last known display name.

## Endpoints

### POST `/api/player/update`

Creates or updates a player's display name. This is intended to be called when a player joins the server to keep their name up-to-date.

**Headers:**
- `Content-Type: application/json`
- `X-Api-Key: <YOUR_API_KEY>`

**Payload:**

```json
{
  "steam_id": "STEAM_0:1:12345",
  "display_name": "PlayerName"
}
```

### POST `/api/collect`

Receives round statistics.

**Headers:**
- `Content-Type: application/json`
- `X-Api-Key: <YOUR_API_KEY>`

**Payload:**

```json
{
  "round_id": "ABCD_EF01_2345_6789",
  "map_name": "ttt_minecraft_b5",
  "winner": "traitors",
  "duration": 245,
  "start_roles": [
    {
      "player_steamid": "STEAM_0:1:12345",
      "role": "innocent"
    }
  ],
  "end_roles": [
    {
      "player_steamid": "STEAM_0:1:12345",
      "role": "innocent"
    }
  ],
  "kills": [
    {
      "attacker_steamid": "STEAM_0:1:12345",
      "attacker_role": "traitor",
      "victim_steamid": "STEAM_0:0:67890",
      "victim_role": "innocent",
      "weapon": "weapon_ttt_knife",
      "headshot": false
    }
  ],
  "buys": [
    {
      "steam_id": "STEAM_0:1:12345",
      "role": "traitor",
      "item": "weapon_ttt_c4"
    }
  ]
}
```

### GET `/api/stats`

Retrieves recent rounds.

**Query Params:**
- `limit`: Number of rounds to return (default 20).
- `offset`: Pagination offset.

**Response:**
JSON array of round objects.
